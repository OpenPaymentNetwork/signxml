
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>signxml &#8212; signxml  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/guzzle.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">signxml  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">signxml</a></li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="
    ../index.html" class="text-logo">signxml</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../index.html">Docs</a></li>
              
                <li><a href="index.html">Module code</a></li>
              
              <li>signxml</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <h1>Source code for signxml</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span><span class="p">,</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="kn">from</span> <span class="nn">eight</span> <span class="kn">import</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">lxml.etree</span> <span class="kn">import</span> <span class="n">Element</span><span class="p">,</span> <span class="n">SubElement</span>

<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">dsa</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">rsa</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric.padding</span> <span class="kn">import</span> <span class="n">PKCS1v15</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.hashes</span> <span class="kn">import</span> <span class="n">Hash</span><span class="p">,</span> <span class="n">SHA1</span><span class="p">,</span> <span class="n">SHA224</span><span class="p">,</span> <span class="n">SHA256</span><span class="p">,</span> <span class="n">SHA384</span><span class="p">,</span> <span class="n">SHA512</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.serialization</span> <span class="kn">import</span> <span class="n">load_der_public_key</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>

<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">InvalidSignature</span><span class="p">,</span> <span class="n">InvalidDigest</span><span class="p">,</span> <span class="n">InvalidInput</span><span class="p">,</span> <span class="n">InvalidCertificate</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="p">(</span><span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span><span class="p">,</span> <span class="n">strip_pem_header</span><span class="p">,</span> <span class="n">add_pem_header</span><span class="p">,</span> <span class="n">ensure_bytes</span><span class="p">,</span> <span class="n">ensure_str</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">,</span>
                   <span class="n">XMLProcessor</span><span class="p">,</span> <span class="n">iterate_pem</span><span class="p">,</span> <span class="n">verify_x509_cert_chain</span><span class="p">,</span> <span class="n">bits_to_bytes_unit</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="n">methods</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;Methods&quot;</span><span class="p">,</span> <span class="s2">&quot;enveloped enveloping detached&quot;</span><span class="p">)</span>

<span class="n">namespaces</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">ds</span><span class="o">=</span><span class="s2">&quot;http://www.w3.org/2000/09/xmldsig#&quot;</span><span class="p">,</span>
    <span class="n">dsig11</span><span class="o">=</span><span class="s2">&quot;http://www.w3.org/2009/xmldsig11#&quot;</span><span class="p">,</span>
    <span class="n">dsig2</span><span class="o">=</span><span class="s2">&quot;http://www.w3.org/2010/xmldsig2#&quot;</span><span class="p">,</span>
    <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span><span class="p">,</span>
    <span class="n">dsig_more</span><span class="o">=</span><span class="s2">&quot;http://www.w3.org/2001/04/xmldsig-more#&quot;</span><span class="p">,</span>
    <span class="n">xenc</span><span class="o">=</span><span class="s2">&quot;http://www.w3.org/2001/04/xmlenc#&quot;</span><span class="p">,</span>
    <span class="n">xenc11</span><span class="o">=</span><span class="s2">&quot;http://www.w3.org/2009/xmlenc11#&quot;</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">ds_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="n">namespaces</span><span class="o">.</span><span class="n">ds</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="n">tag</span>

<span class="k">def</span> <span class="nf">dsig11_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig11</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="n">tag</span>

<span class="k">def</span> <span class="nf">ec_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="n">namespaces</span><span class="o">.</span><span class="n">ec</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="n">tag</span>

<span class="k">def</span> <span class="nf">_remove_sig</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">idempotent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove the signature node from its parent, keeping any tail element.</span>
<span class="sd">    This is needed for eneveloped signatures.</span>

<span class="sd">    :param signature: Signature to remove from payload</span>
<span class="sd">    :type signature: XML ElementTree Element</span>
<span class="sd">    :param idempotent:</span>
<span class="sd">        If True, don&#39;t raise an error if signature is already detached from parent.</span>
<span class="sd">    :type idempotent: boolean</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">signaturep</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">signature</span><span class="o">.</span><span class="n">iterancestors</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">idempotent</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t remove the root signature node&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">signature</span><span class="o">.</span><span class="n">tail</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">signatures</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">signature</span><span class="o">.</span><span class="n">itersiblings</span><span class="p">(</span><span class="n">preceding</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">signaturep</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">signaturep</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">signaturep</span><span class="o">.</span><span class="n">text</span> <span class="o">+</span> <span class="n">signature</span><span class="o">.</span><span class="n">tail</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signaturep</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="n">tail</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">signatures</span><span class="o">.</span><span class="n">tail</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">signatures</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">signatures</span><span class="o">.</span><span class="n">tail</span> <span class="o">+</span> <span class="n">signature</span><span class="o">.</span><span class="n">tail</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signatures</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="n">tail</span>
    <span class="n">signaturep</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>

<div class="viewcode-block" id="VerifyResult"><a class="viewcode-back" href="../index.html#signxml.VerifyResult">[docs]</a><span class="k">class</span> <span class="nc">VerifyResult</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;VerifyResult&quot;</span><span class="p">,</span> <span class="s2">&quot;signed_data signed_xml signature_xml&quot;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The results of a verification return the signed data, the signed xml and the signature xml</span>

<span class="sd">    :param signed_data: The binary data as it was signed (literally)</span>
<span class="sd">    :type data: bytes</span>
<span class="sd">    :param signed_xml: The signed data parsed as XML (or None if parsing failed)</span>
<span class="sd">    :type signed_xml: ElementTree or None</span>
<span class="sd">    :param signature_xml: The signature element parsed as XML</span>
<span class="sd">    :type signed_xml: ElementTree</span>

<span class="sd">    This class is a namedtuple representing structured data returned by ``signxml.XMLVerifier.verify()``. As with any</span>
<span class="sd">    namedtuple, elements of the return value can be accessed as attributes. For example::</span>
<span class="sd">        verified_data = signxml.XMLVerifier().verify(input_data).signed_xml</span>
<span class="sd">    &quot;&quot;&quot;</span></div>

<span class="k">class</span> <span class="nc">XMLSignatureProcessor</span><span class="p">(</span><span class="n">XMLProcessor</span><span class="p">):</span>
    <span class="n">schema_file</span> <span class="o">=</span> <span class="s2">&quot;xmldsig1-schema.xsd&quot;</span>

    <span class="n">known_digest_methods</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">ds</span> <span class="o">+</span> <span class="s2">&quot;sha1&quot;</span><span class="p">:</span> <span class="n">SHA1</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">xenc</span> <span class="o">+</span> <span class="s2">&quot;sha256&quot;</span><span class="p">:</span> <span class="n">SHA256</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;sha224&quot;</span><span class="p">:</span> <span class="n">SHA224</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;sha384&quot;</span><span class="p">:</span> <span class="n">SHA384</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">xenc</span> <span class="o">+</span> <span class="s2">&quot;sha512&quot;</span><span class="p">:</span> <span class="n">SHA512</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">known_hmac_digest_methods</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">ds</span> <span class="o">+</span> <span class="s2">&quot;hmac-sha1&quot;</span><span class="p">:</span> <span class="n">SHA1</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;hmac-sha256&quot;</span><span class="p">:</span> <span class="n">SHA256</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;hmac-sha384&quot;</span><span class="p">:</span> <span class="n">SHA384</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;hmac-sha512&quot;</span><span class="p">:</span> <span class="n">SHA512</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;hmac-sha224&quot;</span><span class="p">:</span> <span class="n">SHA224</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">known_signature_digest_methods</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;rsa-sha256&quot;</span><span class="p">:</span> <span class="n">SHA256</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;ecdsa-sha256&quot;</span><span class="p">:</span> <span class="n">SHA256</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">ds</span> <span class="o">+</span> <span class="s2">&quot;dsa-sha1&quot;</span><span class="p">:</span> <span class="n">SHA1</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">ds</span> <span class="o">+</span> <span class="s2">&quot;rsa-sha1&quot;</span><span class="p">:</span> <span class="n">SHA1</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;rsa-sha224&quot;</span><span class="p">:</span> <span class="n">SHA224</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;rsa-sha384&quot;</span><span class="p">:</span> <span class="n">SHA384</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;rsa-sha512&quot;</span><span class="p">:</span> <span class="n">SHA512</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;ecdsa-sha1&quot;</span><span class="p">:</span> <span class="n">SHA1</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;ecdsa-sha224&quot;</span><span class="p">:</span> <span class="n">SHA224</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;ecdsa-sha384&quot;</span><span class="p">:</span> <span class="n">SHA384</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig_more</span> <span class="o">+</span> <span class="s2">&quot;ecdsa-sha512&quot;</span><span class="p">:</span> <span class="n">SHA512</span><span class="p">,</span>
        <span class="n">namespaces</span><span class="o">.</span><span class="n">dsig11</span> <span class="o">+</span> <span class="s2">&quot;dsa-sha256&quot;</span><span class="p">:</span> <span class="n">SHA256</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">known_digest_tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">method</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">method</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">known_digest_methods</span><span class="p">}</span>
    <span class="n">known_hmac_digest_tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">method</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">method</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">known_hmac_digest_methods</span><span class="p">}</span>
    <span class="n">known_signature_digest_tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">method</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">method</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">known_signature_digest_methods</span><span class="p">}</span>

    <span class="c1"># See https://tools.ietf.org/html/rfc5656</span>
    <span class="n">known_ecdsa_curves</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;urn:oid:1.2.840.10045.3.1.7&quot;</span><span class="p">:</span> <span class="n">ec</span><span class="o">.</span><span class="n">SECP256R1</span><span class="p">,</span>
        <span class="s2">&quot;urn:oid:1.3.132.0.34&quot;</span><span class="p">:</span> <span class="n">ec</span><span class="o">.</span><span class="n">SECP384R1</span><span class="p">,</span>
        <span class="s2">&quot;urn:oid:1.3.132.0.35&quot;</span><span class="p">:</span> <span class="n">ec</span><span class="o">.</span><span class="n">SECP521R1</span><span class="p">,</span>
        <span class="s2">&quot;urn:oid:1.3.132.0.1&quot;</span><span class="p">:</span> <span class="n">ec</span><span class="o">.</span><span class="n">SECT163K1</span><span class="p">,</span>
        <span class="s2">&quot;urn:oid:1.2.840.10045.3.1.1&quot;</span><span class="p">:</span> <span class="n">ec</span><span class="o">.</span><span class="n">SECP192R1</span><span class="p">,</span>
        <span class="s2">&quot;urn:oid:1.3.132.0.33&quot;</span><span class="p">:</span> <span class="n">ec</span><span class="o">.</span><span class="n">SECP224R1</span><span class="p">,</span>
        <span class="s2">&quot;urn:oid:1.3.132.0.26&quot;</span><span class="p">:</span> <span class="n">ec</span><span class="o">.</span><span class="n">SECT233K1</span><span class="p">,</span>
        <span class="s2">&quot;urn:oid:1.3.132.0.27&quot;</span><span class="p">:</span> <span class="n">ec</span><span class="o">.</span><span class="n">SECT233R1</span><span class="p">,</span>
        <span class="s2">&quot;urn:oid:1.3.132.0.16&quot;</span><span class="p">:</span> <span class="n">ec</span><span class="o">.</span><span class="n">SECT283R1</span><span class="p">,</span>
        <span class="s2">&quot;urn:oid:1.3.132.0.36&quot;</span><span class="p">:</span> <span class="n">ec</span><span class="o">.</span><span class="n">SECT409K1</span><span class="p">,</span>
        <span class="s2">&quot;urn:oid:1.3.132.0.37&quot;</span><span class="p">:</span> <span class="n">ec</span><span class="o">.</span><span class="n">SECT409R1</span><span class="p">,</span>
        <span class="s2">&quot;urn:oid:1.3.132.0.38&quot;</span><span class="p">:</span> <span class="n">ec</span><span class="o">.</span><span class="n">SECT571K1</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">known_ecdsa_curve_oids</span> <span class="o">=</span> <span class="p">{</span><span class="n">ec</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">oid</span> <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">ec</span> <span class="ow">in</span> <span class="n">known_ecdsa_curves</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="n">known_c14n_algorithms</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;http://www.w3.org/TR/2001/REC-xml-c14n-20010315&quot;</span><span class="p">,</span>
        <span class="s2">&quot;http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments&quot;</span><span class="p">,</span>
        <span class="s2">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span><span class="p">,</span>
        <span class="s2">&quot;http://www.w3.org/2001/10/xml-exc-c14n#WithComments&quot;</span><span class="p">,</span>
        <span class="s2">&quot;http://www.w3.org/2006/12/xml-c14n11&quot;</span><span class="p">,</span>
        <span class="s2">&quot;http://www.w3.org/2006/12/xml-c14n11#WithComments&quot;</span>
    <span class="p">}</span>
    <span class="n">default_c14n_algorithm</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2006/12/xml-c14n11&quot;</span>

    <span class="n">id_attributes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Id&quot;</span><span class="p">,</span> <span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;xml:id&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_digest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">digest_algorithm</span><span class="p">):</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="n">Hash</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">digest_algorithm</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>
        <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hasher</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_digest_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">digest_algorithm_id</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">methods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_digest_methods</span>
        <span class="k">if</span> <span class="n">digest_algorithm_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s1">&#39;Algorithm &quot;</span><span class="si">{}</span><span class="s1">&quot; is not recognized&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">digest_algorithm_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">methods</span><span class="p">[</span><span class="n">digest_algorithm_id</span><span class="p">]()</span>

    <span class="k">def</span> <span class="nf">_get_digest_method_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">digest_algorithm_tag</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">known_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">known_tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">known_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_digest_tags</span>
        <span class="k">if</span> <span class="n">digest_algorithm_tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_tags</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s1">&#39;Algorithm tag &quot;</span><span class="si">{}</span><span class="s1">&quot; is not recognized&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">digest_algorithm_tag</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_digest_method</span><span class="p">(</span><span class="n">known_tags</span><span class="p">[</span><span class="n">digest_algorithm_tag</span><span class="p">],</span> <span class="n">methods</span><span class="o">=</span><span class="n">methods</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_hmac_digest_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hmac_algorithm_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_digest_method</span><span class="p">(</span><span class="n">hmac_algorithm_id</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">known_hmac_digest_methods</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_hmac_digest_method_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hmac_algorithm_tag</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_digest_method_by_tag</span><span class="p">(</span><span class="n">hmac_algorithm_tag</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">known_hmac_digest_methods</span><span class="p">,</span>
                                              <span class="n">known_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">known_hmac_digest_tags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_signature_digest_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signature_algorithm_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_digest_method</span><span class="p">(</span><span class="n">signature_algorithm_id</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">known_signature_digest_methods</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_signature_digest_method_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signature_algorithm_tag</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_digest_method_by_tag</span><span class="p">(</span><span class="n">signature_algorithm_tag</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">known_signature_digest_methods</span><span class="p">,</span>
                                              <span class="n">known_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">known_signature_digest_tags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;ds&quot;</span><span class="p">,</span> <span class="n">anywhere</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">anywhere</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//&#39;</span> <span class="o">+</span> <span class="n">namespace</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">query</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">namespace</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">query</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">require</span> <span class="ow">and</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;Expected to find XML element </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_findall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;ds&quot;</span><span class="p">,</span> <span class="n">anywhere</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">anywhere</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//&#39;</span> <span class="o">+</span> <span class="n">namespace</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">query</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">namespace</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">query</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_c14n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">inclusive_ns_prefixes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">exclusive</span><span class="p">,</span> <span class="n">with_comments</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span><span class="p">):</span>
            <span class="n">exclusive</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;#WithComments&quot;</span><span class="p">):</span>
            <span class="n">with_comments</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">]</span>

        <span class="n">c14n</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">c14n</span> <span class="o">+=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;c14n&quot;</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="n">exclusive</span><span class="p">,</span> <span class="n">with_comments</span><span class="o">=</span><span class="n">with_comments</span><span class="p">,</span>
                                   <span class="n">inclusive_ns_prefixes</span><span class="o">=</span><span class="n">inclusive_ns_prefixes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exclusive</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># TODO: there must be a nicer way to do this. See also:</span>
            <span class="c1"># http://www.w3.org/TR/xml-c14n, &quot;namespace axis&quot;</span>
            <span class="c1"># http://www.w3.org/TR/xml-c14n2/#sec-Namespace-Processing</span>
            <span class="n">c14n</span> <span class="o">=</span> <span class="n">c14n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; xmlns=&quot;&quot;&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c14n</span>

    <span class="k">def</span> <span class="nf">_resolve_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_root</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">uri_resolver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">reference</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;URI&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">uri</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">doc_root</span>
        <span class="k">elif</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#xpointer(&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;XPointer references are not supported&quot;</span><span class="p">)</span>
            <span class="c1"># doc_root.xpath(uri.lstrip(&quot;#&quot;))[0]</span>
        <span class="k">elif</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">id_attribute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_attributes</span><span class="p">:</span>
                <span class="n">xpath_query</span> <span class="o">=</span> <span class="s2">&quot;//*[@*[local-name() = &#39;</span><span class="si">{}</span><span class="s2">&#39;]=$uri]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_attribute</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">doc_root</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">xpath_query</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;Ambiguous reference URI </span><span class="si">{}</span><span class="s2"> resolved to </span><span class="si">{}</span><span class="s2"> nodes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;Unable to resolve reference URI: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">uri_resolver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;External URI dereferencing is not configured: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">uri_resolver</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;Unable to resolve reference URI: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="XMLSigner"><a class="viewcode-back" href="../index.html#signxml.XMLSigner">[docs]</a><span class="k">class</span> <span class="nc">XMLSigner</span><span class="p">(</span><span class="n">XMLSignatureProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new XML Signature Signer object, which can be used to hold configuration information and sign multiple</span>
<span class="sd">    pieces of data.</span>

<span class="sd">    :param method:</span>
<span class="sd">        ``signxml.methods.enveloped``, ``signxml.methods.enveloping``, or ``signxml.methods.detached``. See the list</span>
<span class="sd">        of signature types under `XML Signature Syntax and Processing Version 2.0, Definitions</span>
<span class="sd">        &lt;http://www.w3.org/TR/xmldsig-core2/#sec-Definitions&gt;`_.</span>
<span class="sd">    :type method: :py:class:`methods`</span>
<span class="sd">    :param signature_algorithm:</span>
<span class="sd">        Algorithm that will be used to generate the signature, composed of the signature algorithm and the digest</span>
<span class="sd">        algorithm, separated by a hyphen. All algorithm IDs listed under the `Algorithm Identifiers and</span>
<span class="sd">        Implementation Requirements &lt;http://www.w3.org/TR/xmldsig-core1/#sec-AlgID&gt;`_ section of the XML Signature</span>
<span class="sd">        1.1 standard are supported.</span>
<span class="sd">    :type signature_algorithm: string</span>
<span class="sd">    :param digest_algorithm: Algorithm that will be used to hash the data during signature generation. All algorithm IDs</span>
<span class="sd">        listed under the `Algorithm Identifiers and Implementation Requirements</span>
<span class="sd">        &lt;http://www.w3.org/TR/xmldsig-core1/#sec-AlgID&gt;`_ section of the XML Signature 1.1 standard are supported.</span>
<span class="sd">    :type digest_algorithm: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">methods</span><span class="o">.</span><span class="n">enveloped</span><span class="p">,</span> <span class="n">signature_algorithm</span><span class="o">=</span><span class="s2">&quot;rsa-sha256&quot;</span><span class="p">,</span> <span class="n">digest_algorithm</span><span class="o">=</span><span class="s2">&quot;sha256&quot;</span><span class="p">,</span>
                 <span class="n">c14n_algorithm</span><span class="o">=</span><span class="n">XMLSignatureProcessor</span><span class="o">.</span><span class="n">default_c14n_algorithm</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;Unknown signature method </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span> <span class="o">=</span> <span class="n">signature_algorithm</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_signature_digest_tags</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_hmac_digest_tags</span>
        <span class="k">assert</span> <span class="n">digest_algorithm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_digest_tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">digest_alg</span> <span class="o">=</span> <span class="n">digest_algorithm</span>
        <span class="k">assert</span> <span class="n">c14n_algorithm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_c14n_algorithms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c14n_alg</span> <span class="o">=</span> <span class="n">c14n_algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespaces</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">namespaces</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="XMLSigner.sign"><a class="viewcode-back" href="../index.html#signxml.XMLSigner.sign">[docs]</a>    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cert</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">id_attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">always_add_key_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">payload_inclusive_ns_prefixes</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>
             <span class="n">signature_inclusive_ns_prefixes</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span> <span class="n">signature_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sign the data and return the root element of the resulting XML tree.</span>

<span class="sd">        :param data: Data to sign</span>
<span class="sd">        :type data: String, file-like object, or XML ElementTree Element API compatible object</span>
<span class="sd">        :param key:</span>
<span class="sd">            Key to be used for signing. When signing with a certificate or RSA/DSA/ECDSA key, this can be a string/bytes</span>
<span class="sd">            containing a PEM-formatted key, or a :py:class:`cryptography.hazmat.primitives.interfaces.RSAPrivateKey`,</span>
<span class="sd">            :py:class:`cryptography.hazmat.primitives.interfaces.DSAPrivateKey`, or</span>
<span class="sd">            :py:class:`cryptography.hazmat.primitives.interfaces.EllipticCurvePrivateKey` object. When signing with a</span>
<span class="sd">            HMAC, this should be a string containing the shared secret.</span>
<span class="sd">        :type key:</span>
<span class="sd">            string, bytes, :py:class:`cryptography.hazmat.primitives.interfaces.RSAPrivateKey`,</span>
<span class="sd">            :py:class:`cryptography.hazmat.primitives.interfaces.DSAPrivateKey`, or</span>
<span class="sd">            :py:class:`cryptography.hazmat.primitives.interfaces.EllipticCurvePrivateKey` object</span>
<span class="sd">        :param passphrase: Passphrase to use to decrypt the key, if any.</span>
<span class="sd">        :type passphrase: string</span>
<span class="sd">        :param cert:</span>
<span class="sd">            X.509 certificate to use for signing. This should be a string containing a PEM-formatted certificate, or an</span>
<span class="sd">            array of strings or OpenSSL.crypto.X509 objects containing the certificate and a chain of intermediate</span>
<span class="sd">            certificates.</span>
<span class="sd">        :type cert: string, array of strings, or array of OpenSSL.crypto.X509 objects</span>
<span class="sd">        :param reference_uri:</span>
<span class="sd">            Custom reference URI or list of reference URIs to incorporate into the signature. When ``method`` is set to</span>
<span class="sd">            ``detached`` or ``enveloped``, reference URIs are set to this value and only the referenced elements are</span>
<span class="sd">            signed.</span>
<span class="sd">        :type reference_uri: string or list</span>
<span class="sd">        :param key_name: Add a KeyName element in the KeyInfo element that may be used by the signer to communicate a</span>
<span class="sd">            key identifier to the recipient. Typically, KeyName contains an identifier related to the key pair used to</span>
<span class="sd">            sign the message.</span>
<span class="sd">        :type key_name: string</span>
<span class="sd">        :param key_info:</span>
<span class="sd">            A custom KeyInfo element to insert in the signature. Use this to supply ``&lt;wsse:SecurityTokenReference&gt;``</span>
<span class="sd">            or other custom key references. An example value can be found here:</span>
<span class="sd">            https://github.com/XML-Security/signxml/blob/master/test/wsse_keyinfo.xml</span>
<span class="sd">        :type key_info: :py:class:`lxml.etree.Element`</span>
<span class="sd">        :param id_attribute:</span>
<span class="sd">            Name of the attribute whose value ``URI`` refers to. By default, SignXML will search for &quot;Id&quot;, then &quot;ID&quot;.</span>
<span class="sd">        :type id_attribute: string</span>
<span class="sd">        :param always_add_key_value:</span>
<span class="sd">            Write the key value to the KeyInfo element even if a X509 certificate is present. Use of this parameter</span>
<span class="sd">            is discouraged, as it introduces an ambiguity and a security hazard. The public key used to sign the</span>
<span class="sd">            document is already encoded in the certificate (which is in X509Data), so the verifier must either ignore</span>
<span class="sd">            KeyValue or make sure it matches what&#39;s in the certificate. This parameter is provided for compatibility</span>
<span class="sd">            purposes only.</span>
<span class="sd">        :type always_add_key_value: boolean</span>
<span class="sd">        :param payload_inclusive_ns_prefixes:</span>
<span class="sd">            Provide a list of XML namespace prefixes whose declarations should be preserved when canonicalizing the</span>
<span class="sd">            content referenced by the signature (**InclusiveNamespaces PrefixList**).</span>
<span class="sd">        :type inclusive_ns_prefixes: string</span>
<span class="sd">        :param signature_inclusive_ns_prefixes:</span>
<span class="sd">            Provide a list of XML namespace prefixes whose declarations should be preserved when canonicalizing the</span>
<span class="sd">            signature itself (**InclusiveNamespaces PrefixList**).</span>
<span class="sd">        :type signature_inclusive_ns_prefixes: string</span>
<span class="sd">        :param signature_properties:</span>
<span class="sd">            One or more Elements that are to be included in the SignatureProperies section when using the detached</span>
<span class="sd">            method.</span>
<span class="sd">        :type signature_properties: :py:class:`lxml.etree.Element` or list of :py:class:`lxml.etree.Element`s</span>

<span class="sd">        :returns:</span>
<span class="sd">            A :py:class:`lxml.etree.Element` object representing the root of the XML tree containing the signature and</span>
<span class="sd">            the payload data.</span>

<span class="sd">        To specify the location of an enveloped signature within **data**, insert a</span>
<span class="sd">        ``&lt;ds:Signature Id=&quot;placeholder&quot;&gt;&lt;/ds:Signature&gt;`` element in **data** (where</span>
<span class="sd">        &quot;ds&quot; is the &quot;http://www.w3.org/2000/09/xmldsig#&quot; namespace). This element will</span>
<span class="sd">        be replaced by the generated signature, and excised when generating the digest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">id_attribute</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_attributes</span> <span class="o">=</span> <span class="p">(</span><span class="n">id_attribute</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">cert_chain</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterate_pem</span><span class="p">(</span><span class="n">cert</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cert_chain</span> <span class="o">=</span> <span class="n">cert</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference_uri</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">reference_uris</span> <span class="o">=</span> <span class="p">[</span><span class="n">reference_uri</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reference_uris</span> <span class="o">=</span> <span class="n">reference_uri</span>

        <span class="n">sig_root</span><span class="p">,</span> <span class="n">doc_root</span><span class="p">,</span> <span class="n">c14n_inputs</span><span class="p">,</span> <span class="n">reference_uris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reference_uris</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">methods</span><span class="o">.</span><span class="n">detached</span> <span class="ow">and</span> <span class="n">signature_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reference_uris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#prop&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signature_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signature_properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">signature_properties</span> <span class="o">=</span> <span class="p">[</span><span class="n">signature_properties</span><span class="p">]</span>
            <span class="n">signature_properties_el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_signature_properties</span><span class="p">(</span><span class="n">signature_properties</span><span class="p">)</span>
            <span class="n">c14n_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signature_properties_el</span><span class="p">)</span>

        <span class="n">signed_info_element</span><span class="p">,</span> <span class="n">signature_value_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_sig</span><span class="p">(</span><span class="n">sig_root</span><span class="p">,</span> <span class="n">reference_uris</span><span class="p">,</span> <span class="n">c14n_inputs</span><span class="p">,</span>
                                                                       <span class="n">sig_insp</span><span class="o">=</span><span class="n">signature_inclusive_ns_prefixes</span><span class="p">,</span>
                                                                       <span class="n">payload_insp</span><span class="o">=</span><span class="n">payload_inclusive_ns_prefixes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s1">&#39;Parameter &quot;key&quot; is required&#39;</span><span class="p">)</span>

        <span class="n">signed_info_c14n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c14n</span><span class="p">(</span><span class="n">signed_info_element</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c14n_alg</span><span class="p">,</span>
                                      <span class="n">inclusive_ns_prefixes</span><span class="o">=</span><span class="n">signature_inclusive_ns_prefixes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;hmac-&quot;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.hmac</span> <span class="kn">import</span> <span class="n">HMAC</span>
            <span class="n">signer</span> <span class="o">=</span> <span class="n">HMAC</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                          <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hmac_digest_method_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="p">),</span>
                          <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>
            <span class="n">signer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">signed_info_c14n</span><span class="p">)</span>
            <span class="n">signature_value_element</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">ensure_str</span><span class="p">(</span><span class="n">b64encode</span><span class="p">(</span><span class="n">signer</span><span class="o">.</span><span class="n">finalize</span><span class="p">()))</span>
            <span class="n">sig_root</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signature_value_element</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dsa-&quot;</span><span class="p">,</span> <span class="s2">&quot;rsa-&quot;</span><span class="p">,</span> <span class="s2">&quot;ecdsa-&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.serialization</span> <span class="kn">import</span> <span class="n">load_pem_private_key</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">load_pem_private_key</span><span class="p">(</span><span class="n">ensure_bytes</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="n">passphrase</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>

            <span class="n">hash_alg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_signature_digest_method_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;dsa-&quot;</span><span class="p">):</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">signed_info_c14n</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">hash_alg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ecdsa-&quot;</span><span class="p">):</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">signed_info_c14n</span><span class="p">,</span> <span class="n">signature_algorithm</span><span class="o">=</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDSA</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hash_alg</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rsa-&quot;</span><span class="p">):</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">signed_info_c14n</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">PKCS1v15</span><span class="p">(),</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">hash_alg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;dsa-&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ecdsa-&quot;</span><span class="p">):</span>
                <span class="c1"># Note: The output of the DSA and ECDSA signers is a DER-encoded ASN.1 sequence of two DER integers.</span>
                <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decode_dss_signature</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>
                <span class="n">int_len</span> <span class="o">=</span> <span class="n">bits_to_bytes_unit</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">key_size</span><span class="p">)</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">int_len</span><span class="p">)</span> <span class="o">+</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">int_len</span><span class="p">)</span>

            <span class="n">signature_value_element</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">ensure_str</span><span class="p">(</span><span class="n">b64encode</span><span class="p">(</span><span class="n">signature</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">key_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">key_info</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">sig_root</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;KeyInfo&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">key_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">keyname</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">key_info</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;KeyName&quot;</span><span class="p">))</span>
                    <span class="n">keyname</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">key_name</span>

                <span class="k">if</span> <span class="n">cert_chain</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">always_add_key_value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_key_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key_info</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cert_chain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">x509_data</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">key_info</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;X509Data&quot;</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">cert</span> <span class="ow">in</span> <span class="n">cert_chain</span><span class="p">:</span>
                        <span class="n">x509_certificate</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">x509_data</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;X509Certificate&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                            <span class="n">x509_certificate</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">strip_pem_header</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="kn">from</span> <span class="nn">OpenSSL.crypto</span> <span class="kn">import</span> <span class="n">dump_certificate</span><span class="p">,</span> <span class="n">FILETYPE_PEM</span>
                            <span class="n">x509_certificate</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">strip_pem_header</span><span class="p">(</span><span class="n">dump_certificate</span><span class="p">(</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">cert</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sig_root</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">methods</span><span class="o">.</span><span class="n">enveloping</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c14n_input</span> <span class="ow">in</span> <span class="n">c14n_inputs</span><span class="p">:</span>
                <span class="n">doc_root</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c14n_input</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">methods</span><span class="o">.</span><span class="n">detached</span> <span class="ow">and</span> <span class="n">signature_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sig_root</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signature_properties_el</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">doc_root</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">methods</span><span class="o">.</span><span class="n">enveloped</span> <span class="k">else</span> <span class="n">sig_root</span></div>

    <span class="k">def</span> <span class="nf">_get_c14n_inputs_from_reference_uris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_root</span><span class="p">,</span> <span class="n">reference_uris</span><span class="p">):</span>
        <span class="n">c14n_inputs</span><span class="p">,</span> <span class="n">new_reference_uris</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">reference_uri</span> <span class="ow">in</span> <span class="n">reference_uris</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reference_uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="n">reference_uri</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">reference_uri</span>
            <span class="n">c14n_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resolve_reference</span><span class="p">(</span><span class="n">doc_root</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;URI&#39;</span><span class="p">:</span> <span class="n">reference_uri</span><span class="p">})))</span>
            <span class="n">new_reference_uris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_uri</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c14n_inputs</span><span class="p">,</span> <span class="n">new_reference_uris</span>

    <span class="k">def</span> <span class="nf">_unpack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">reference_uris</span><span class="p">):</span>
        <span class="n">sig_root</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;Signature&quot;</span><span class="p">),</span> <span class="n">nsmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespaces</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">methods</span><span class="o">.</span><span class="n">enveloped</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;When using enveloped signature, **data** must be an XML element&quot;</span><span class="p">)</span>
            <span class="n">doc_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_root</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">c14n_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_root</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">reference_uris</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Only sign the referenced element(s)</span>
                <span class="n">c14n_inputs</span><span class="p">,</span> <span class="n">reference_uris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_c14n_inputs_from_reference_uris</span><span class="p">(</span><span class="n">doc_root</span><span class="p">,</span> <span class="n">reference_uris</span><span class="p">)</span>

            <span class="n">signature_placeholders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_findall</span><span class="p">(</span><span class="n">doc_root</span><span class="p">,</span> <span class="s2">&quot;Signature[@Id=&#39;placeholder&#39;]&quot;</span><span class="p">,</span> <span class="n">anywhere</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signature_placeholders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">doc_root</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_root</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">signature_placeholders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sig_root</span> <span class="o">=</span> <span class="n">signature_placeholders</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">sig_root</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">c14n_input</span> <span class="ow">in</span> <span class="n">c14n_inputs</span><span class="p">:</span>
                    <span class="n">placeholders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_findall</span><span class="p">(</span><span class="n">c14n_input</span><span class="p">,</span> <span class="s2">&quot;Signature[@Id=&#39;placeholder&#39;]&quot;</span><span class="p">,</span> <span class="n">anywhere</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">placeholders</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">placeholders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="n">_remove_sig</span><span class="p">(</span><span class="n">placeholders</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;Enveloped signature input contains more than one placeholder&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">reference_uris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Set default reference URIs based on signed data ID attribute values</span>
                <span class="n">reference_uris</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">c14n_input</span> <span class="ow">in</span> <span class="n">c14n_inputs</span><span class="p">:</span>
                    <span class="n">payload_id</span> <span class="o">=</span> <span class="n">c14n_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Id&quot;</span><span class="p">,</span> <span class="n">c14n_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">))</span>
                    <span class="n">reference_uris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">payload_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">payload_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">methods</span><span class="o">.</span><span class="n">detached</span><span class="p">:</span>
            <span class="n">doc_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_root</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reference_uris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reference_uris</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Id&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">)))]</span>
                <span class="n">c14n_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_root</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">c14n_inputs</span><span class="p">,</span> <span class="n">reference_uris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_c14n_inputs_from_reference_uris</span><span class="p">(</span><span class="n">doc_root</span><span class="p">,</span> <span class="n">reference_uris</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">InvalidInput</span><span class="p">:</span>  <span class="c1"># Dummy reference URI</span>
                <span class="n">c14n_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_root</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">methods</span><span class="o">.</span><span class="n">enveloping</span><span class="p">:</span>
            <span class="n">doc_root</span> <span class="o">=</span> <span class="n">sig_root</span>
            <span class="n">c14n_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Element</span><span class="p">(</span><span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;Object&quot;</span><span class="p">),</span> <span class="n">nsmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespaces</span><span class="p">,</span> <span class="n">Id</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="n">c14n_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c14n_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_root</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="n">reference_uris</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#object&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sig_root</span><span class="p">,</span> <span class="n">doc_root</span><span class="p">,</span> <span class="n">c14n_inputs</span><span class="p">,</span> <span class="n">reference_uris</span>

    <span class="k">def</span> <span class="nf">_build_sig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig_root</span><span class="p">,</span> <span class="n">reference_uris</span><span class="p">,</span> <span class="n">c14n_inputs</span><span class="p">,</span> <span class="n">sig_insp</span><span class="p">,</span> <span class="n">payload_insp</span><span class="p">):</span>
        <span class="n">signed_info</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">sig_root</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;SignedInfo&quot;</span><span class="p">),</span> <span class="n">nsmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespaces</span><span class="p">)</span>
        <span class="n">sig_c14n_method</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">signed_info</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;CanonicalizationMethod&quot;</span><span class="p">),</span> <span class="n">Algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c14n_alg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sig_insp</span><span class="p">:</span>
            <span class="n">SubElement</span><span class="p">(</span><span class="n">sig_c14n_method</span><span class="p">,</span> <span class="n">ec_tag</span><span class="p">(</span><span class="s2">&quot;InclusiveNamespaces&quot;</span><span class="p">),</span> <span class="n">PrefixList</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sig_insp</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;hmac-&quot;</span><span class="p">):</span>
            <span class="n">algorithm_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_hmac_digest_tags</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">algorithm_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_signature_digest_tags</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="p">]</span>
        <span class="n">SubElement</span><span class="p">(</span><span class="n">signed_info</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;SignatureMethod&quot;</span><span class="p">),</span> <span class="n">Algorithm</span><span class="o">=</span><span class="n">algorithm_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">reference_uri</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reference_uris</span><span class="p">):</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">signed_info</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;Reference&quot;</span><span class="p">),</span> <span class="n">URI</span><span class="o">=</span><span class="n">reference_uri</span><span class="p">)</span>
            <span class="n">transforms</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;Transforms&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">methods</span><span class="o">.</span><span class="n">enveloped</span><span class="p">:</span>
                <span class="n">SubElement</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;Transform&quot;</span><span class="p">),</span> <span class="n">Algorithm</span><span class="o">=</span><span class="n">namespaces</span><span class="o">.</span><span class="n">ds</span> <span class="o">+</span> <span class="s2">&quot;enveloped-signature&quot;</span><span class="p">)</span>
                <span class="n">SubElement</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;Transform&quot;</span><span class="p">),</span> <span class="n">Algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c14n_alg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c14n_xform</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;Transform&quot;</span><span class="p">),</span> <span class="n">Algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c14n_alg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">payload_insp</span><span class="p">:</span>
                    <span class="n">SubElement</span><span class="p">(</span><span class="n">c14n_xform</span><span class="p">,</span> <span class="n">ec_tag</span><span class="p">(</span><span class="s2">&quot;InclusiveNamespaces&quot;</span><span class="p">),</span> <span class="n">PrefixList</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">payload_insp</span><span class="p">))</span>

            <span class="n">SubElement</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;DigestMethod&quot;</span><span class="p">),</span> <span class="n">Algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">known_digest_tags</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">digest_alg</span><span class="p">])</span>
            <span class="n">digest_value</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;DigestValue&quot;</span><span class="p">))</span>
            <span class="n">payload_c14n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c14n</span><span class="p">(</span><span class="n">c14n_inputs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c14n_alg</span><span class="p">,</span> <span class="n">inclusive_ns_prefixes</span><span class="o">=</span><span class="n">payload_insp</span><span class="p">)</span>
            <span class="n">digest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_digest</span><span class="p">(</span><span class="n">payload_c14n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_digest_method_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digest_alg</span><span class="p">))</span>
            <span class="n">digest_value</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">ensure_str</span><span class="p">(</span><span class="n">b64encode</span><span class="p">(</span><span class="n">digest</span><span class="p">))</span>
        <span class="n">signature_value</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">sig_root</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;SignatureValue&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">signed_info</span><span class="p">,</span> <span class="n">signature_value</span>

    <span class="k">def</span> <span class="nf">_build_signature_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signature_properties</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;Object&quot;</span><span class="p">),</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Id&#39;</span><span class="p">:</span> <span class="s1">&#39;prop&#39;</span><span class="p">},</span> <span class="n">nsmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespaces</span><span class="p">)</span>
        <span class="n">signature_properties_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;SignatureProperties&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">signature_properties</span><span class="p">):</span>
            <span class="n">signature_property</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;SignatureProperty&quot;</span><span class="p">),</span>
                                         <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Id&quot;</span><span class="p">:</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Id&#39;</span><span class="p">,</span> <span class="s2">&quot;sigprop</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span>
                                                 <span class="s2">&quot;Target&quot;</span><span class="p">:</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Target&#39;</span><span class="p">,</span> <span class="s2">&quot;#sigproptarget</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))})</span>
            <span class="n">signature_property</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
            <span class="n">signature_properties_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signature_property</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signature_properties_el</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">_serialize_key_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_info_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the public components of the key to the signature (see https://www.w3.org/TR/xmldsig-core2/#sec-KeyValue).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key_value</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">key_info_element</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;KeyValue&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rsa-&quot;</span><span class="p">):</span>
            <span class="n">rsa_key_value</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">key_value</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;RSAKeyValue&quot;</span><span class="p">))</span>
            <span class="n">modulus</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">rsa_key_value</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;Modulus&quot;</span><span class="p">))</span>
            <span class="n">modulus</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">ensure_str</span><span class="p">(</span><span class="n">b64encode</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">n</span><span class="p">)))</span>
            <span class="n">exponent</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">rsa_key_value</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;Exponent&quot;</span><span class="p">))</span>
            <span class="n">exponent</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">ensure_str</span><span class="p">(</span><span class="n">b64encode</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;dsa-&quot;</span><span class="p">):</span>
            <span class="n">dsa_key_value</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">key_value</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;DSAKeyValue&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">dsa_key_value</span><span class="p">,</span> <span class="n">ds_tag</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>

                <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                    <span class="n">key_params</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key_params</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span><span class="o">.</span><span class="n">parameter_numbers</span><span class="p">()</span>

                <span class="n">e</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">ensure_str</span><span class="p">(</span><span class="n">b64encode</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">key_params</span><span class="p">,</span> <span class="n">field</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_alg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ecdsa-&quot;</span><span class="p">):</span>
            <span class="n">ec_key_value</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">key_value</span><span class="p">,</span> <span class="n">dsig11_tag</span><span class="p">(</span><span class="s2">&quot;ECKeyValue&quot;</span><span class="p">),</span> <span class="n">nsmap</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">dsig11</span><span class="o">=</span><span class="n">namespaces</span><span class="o">.</span><span class="n">dsig11</span><span class="p">))</span>
            <span class="n">named_curve</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">ec_key_value</span><span class="p">,</span> <span class="n">dsig11_tag</span><span class="p">(</span><span class="s2">&quot;NamedCurve&quot;</span><span class="p">),</span>
                                     <span class="n">URI</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">known_ecdsa_curve_oids</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
            <span class="n">public_key</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">ec_key_value</span><span class="p">,</span> <span class="n">dsig11_tag</span><span class="p">(</span><span class="s2">&quot;PublicKey&quot;</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">x</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">y</span>
            <span class="n">public_key</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">ensure_str</span><span class="p">(</span><span class="n">b64encode</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span></div>

<div class="viewcode-block" id="XMLVerifier"><a class="viewcode-back" href="../index.html#signxml.XMLVerifier">[docs]</a><span class="k">class</span> <span class="nc">XMLVerifier</span><span class="p">(</span><span class="n">XMLSignatureProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new XML Signature Verifier object, which can be used to hold configuration information and verify multiple</span>
<span class="sd">    pieces of data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_get_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">ds_tag</span><span class="p">(</span><span class="s2">&quot;Signature&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">root</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;Signature&quot;</span><span class="p">,</span> <span class="n">anywhere</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_signature_with_pubkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signed_info_c14n</span><span class="p">,</span> <span class="n">raw_signature</span><span class="p">,</span> <span class="n">key_value</span><span class="p">,</span> <span class="n">der_encoded_key_value</span><span class="p">,</span>
                                      <span class="n">signature_alg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">der_encoded_key_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">load_der_public_key</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">der_encoded_key_value</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>
        <span class="k">if</span> <span class="s2">&quot;ecdsa-&quot;</span> <span class="ow">in</span> <span class="n">signature_alg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ec_key_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">key_value</span><span class="p">,</span> <span class="s2">&quot;ECKeyValue&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;dsig11&quot;</span><span class="p">)</span>
                <span class="n">named_curve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">ec_key_value</span><span class="p">,</span> <span class="s2">&quot;NamedCurve&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;dsig11&quot;</span><span class="p">)</span>
                <span class="n">public_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">ec_key_value</span><span class="p">,</span> <span class="s2">&quot;PublicKey&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;dsig11&quot;</span><span class="p">)</span>
                <span class="n">key_data</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">public_key</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">key_data</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">key_data</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">key_data</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">key_data</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:])</span>
                <span class="n">curve_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_ecdsa_curves</span><span class="p">[</span><span class="n">named_curve</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;URI&quot;</span><span class="p">)]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">ec</span><span class="o">.</span><span class="n">EllipticCurvePublicNumbers</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="n">curve_class</span><span class="p">())</span><span class="o">.</span><span class="n">public_key</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ec</span><span class="o">.</span><span class="n">EllipticCurvePublicKey</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;DER encoded key value does not match specified signature algorithm&quot;</span><span class="p">)</span>
            <span class="n">dss_signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_dss_signature</span><span class="p">(</span><span class="n">raw_signature</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">key_size</span><span class="p">)</span>
            <span class="n">key</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span>
                <span class="n">dss_signature</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">signed_info_c14n</span><span class="p">,</span>
                <span class="n">signature_algorithm</span><span class="o">=</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDSA</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_signature_digest_method</span><span class="p">(</span><span class="n">signature_alg</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;dsa-&quot;</span> <span class="ow">in</span> <span class="n">signature_alg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dsa_key_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">key_value</span><span class="p">,</span> <span class="s2">&quot;DSAKeyValue&quot;</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long</span><span class="p">(</span><span class="n">dsa_key_value</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">)</span>
                <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long</span><span class="p">(</span><span class="n">dsa_key_value</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">)</span>
                <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long</span><span class="p">(</span><span class="n">dsa_key_value</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long</span><span class="p">(</span><span class="n">dsa_key_value</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span>
                <span class="n">pn</span> <span class="o">=</span> <span class="n">dsa</span><span class="o">.</span><span class="n">DSAPublicNumbers</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">parameter_numbers</span><span class="o">=</span><span class="n">dsa</span><span class="o">.</span><span class="n">DSAParameterNumbers</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">g</span><span class="p">))</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">public_key</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dsa</span><span class="o">.</span><span class="n">DSAPublicKey</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;DER encoded key value does not match specified signature algorithm&quot;</span><span class="p">)</span>
            <span class="c1"># TODO: supply meaningful key_size_bits for signature length assertion</span>
            <span class="n">dss_signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_dss_signature</span><span class="p">(</span><span class="n">raw_signature</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_signature</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">key</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">dss_signature</span><span class="p">,</span>
                       <span class="n">data</span><span class="o">=</span><span class="n">signed_info_c14n</span><span class="p">,</span>
                       <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_signature_digest_method</span><span class="p">(</span><span class="n">signature_alg</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s2">&quot;rsa-&quot;</span> <span class="ow">in</span> <span class="n">signature_alg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rsa_key_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">key_value</span><span class="p">,</span> <span class="s2">&quot;RSAKeyValue&quot;</span><span class="p">)</span>
                <span class="n">modulus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long</span><span class="p">(</span><span class="n">rsa_key_value</span><span class="p">,</span> <span class="s2">&quot;Modulus&quot;</span><span class="p">)</span>
                <span class="n">exponent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long</span><span class="p">(</span><span class="n">rsa_key_value</span><span class="p">,</span> <span class="s2">&quot;Exponent&quot;</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPublicNumbers</span><span class="p">(</span><span class="n">e</span><span class="o">=</span><span class="n">exponent</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">modulus</span><span class="p">)</span><span class="o">.</span><span class="n">public_key</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPublicKey</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;DER encoded key value does not match specified signature algorithm&quot;</span><span class="p">)</span>
            <span class="n">key</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">raw_signature</span><span class="p">,</span>
                       <span class="n">data</span><span class="o">=</span><span class="n">signed_info_c14n</span><span class="p">,</span>
                       <span class="n">padding</span><span class="o">=</span><span class="n">PKCS1v15</span><span class="p">(),</span>
                       <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_signature_digest_method</span><span class="p">(</span><span class="n">signature_alg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_encode_dss_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_signature</span><span class="p">,</span> <span class="n">key_size_bits</span><span class="p">):</span>
        <span class="n">want_raw_signature_len</span> <span class="o">=</span> <span class="n">bits_to_bytes_unit</span><span class="p">(</span><span class="n">key_size_bits</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_signature</span><span class="p">)</span> <span class="o">!=</span> <span class="n">want_raw_signature_len</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSignature</span><span class="p">(</span>
                <span class="s2">&quot;Expected </span><span class="si">%d</span><span class="s2"> byte SignatureValue, got </span><span class="si">%d</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">want_raw_signature_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_signature</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="n">int_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_signature</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">raw_signature</span><span class="p">[:</span><span class="n">int_len</span><span class="p">])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">raw_signature</span><span class="p">[</span><span class="n">int_len</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">encode_dss_signature</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_inclusive_ns_prefixes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transform_node</span><span class="p">):</span>
        <span class="n">inclusive_namespaces</span> <span class="o">=</span> <span class="n">transform_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./ec:InclusiveNamespaces[@PrefixList]&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inclusive_namespaces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inclusive_namespaces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PrefixList&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_transforms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">transforms_node</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">c14n_algorithm</span><span class="p">):</span>
        <span class="n">transforms</span><span class="p">,</span> <span class="n">c14n_applied</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">transforms_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_findall</span><span class="p">(</span><span class="n">transforms_node</span><span class="p">,</span> <span class="s2">&quot;Transform&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="n">transforms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">transform</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Algorithm&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;</span><span class="p">:</span>
                <span class="n">_remove_sig</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">idempotent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="n">transforms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">transform</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Algorithm&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;http://www.w3.org/2000/09/xmldsig#base64&quot;</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="n">transforms</span><span class="p">:</span>
            <span class="n">algorithm</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Algorithm&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_c14n_algorithms</span><span class="p">:</span>
                <span class="n">inclusive_ns_prefixes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inclusive_ns_prefixes</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c14n</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">,</span> <span class="n">inclusive_ns_prefixes</span><span class="o">=</span><span class="n">inclusive_ns_prefixes</span><span class="p">)</span>
                <span class="n">c14n_applied</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c14n_applied</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c14n</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">c14n_algorithm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">payload</span>

<div class="viewcode-block" id="XMLVerifier.verify"><a class="viewcode-back" href="../index.html#signxml.XMLVerifier.verify">[docs]</a>    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">require_x509</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">x509_cert</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cert_subject_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cert_resolver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">ca_pem_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ca_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hmac_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uri_resolver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">id_attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expect_references</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ignore_ambiguous_key_info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the XML signature supplied in the data and return the XML node signed by the signature, or raise an</span>
<span class="sd">        exception if the signature is not valid. By default, this requires the signature to be generated using a valid</span>
<span class="sd">        X.509 certificate. To enable other means of signature validation, set the **require_x509** argument to `False`.</span>

<span class="sd">        .. admonition:: See what is signed</span>

<span class="sd">         It is important to understand and follow the best practice rule of &quot;See what is signed&quot; when verifying XML</span>
<span class="sd">         signatures. The gist of this rule is: if your application neglects to verify that the information it trusts is</span>
<span class="sd">         what was actually signed, the attacker can supply a valid signature but point you to malicious data that wasn&#39;t</span>
<span class="sd">         signed by that signature.</span>

<span class="sd">         In SignXML, you can ensure that the information signed is what you expect to be signed by only trusting the</span>
<span class="sd">         data returned by the ``verify()`` method. The return value is the XML node or string that was signed. Also,</span>
<span class="sd">         depending on the canonicalization method used by the signature, comments in the XML data may not be subject to</span>
<span class="sd">         signing, so may need to be untrusted. If so, they are excised from the return value of ``verify()``.</span>

<span class="sd">         **Recommended reading:** http://www.w3.org/TR/xmldsig-bestpractices/#practices-applications</span>

<span class="sd">        .. admonition:: Establish trust</span>

<span class="sd">         If you do not supply any keyword arguments to ``verify()``, the default behavior is to trust **any** valid XML</span>
<span class="sd">         signature generated using a valid X.509 certificate trusted by your system&#39;s CA store. This means anyone can</span>
<span class="sd">         get an SSL certificate and generate a signature that you will trust. To establish trust in the signer, use the</span>
<span class="sd">         ``x509_cert`` argument to specify a certificate that was pre-shared out-of-band (e.g. via SAML metadata, as</span>
<span class="sd">         shown in :ref:`Verifying SAML assertions &lt;verifying-saml-assertions&gt;`), or ``cert_subject_name`` to specify a</span>
<span class="sd">         subject name that must be in the signing X.509 certificate given by the signature (verified as if it were a</span>
<span class="sd">         domain name), or ``ca_pem_file``/``ca_path`` to give a custom CA.</span>

<span class="sd">        :param data: Signature data to verify</span>
<span class="sd">        :type data: String, file-like object, or XML ElementTree Element API compatible object</span>
<span class="sd">        :param require_x509:</span>
<span class="sd">            If ``True``, a valid X.509 certificate-based signature with an established chain of trust is required to</span>
<span class="sd">            pass validation. If ``False``, other types of valid signatures (e.g. HMAC or RSA public key) are accepted.</span>
<span class="sd">        :type require_x509: boolean</span>
<span class="sd">        :param x509_cert:</span>
<span class="sd">            A trusted external X.509 certificate, given as a PEM-formatted string or OpenSSL.crypto.X509 object, to use</span>
<span class="sd">            for verification. Overrides any X.509 certificate information supplied by the signature. If left set to</span>
<span class="sd">            ``None``, requires that the signature supply a valid X.509 certificate chain that validates against the</span>
<span class="sd">            known certificate authorities. Implies **require_x509=True**.</span>
<span class="sd">        :type x509_cert: string or OpenSSL.crypto.X509</span>
<span class="sd">        :param cert_subject_name:</span>
<span class="sd">            Subject Common Name to check the signing X.509 certificate against. Implies **require_x509=True**.</span>
<span class="sd">        :type cert_subject_name: string</span>
<span class="sd">        :param cert_resolver:</span>
<span class="sd">            Function to use to resolve trusted X.509 certificates when X509IssuerSerial and X509Digest references are</span>
<span class="sd">            found in the signature. The function is called with the keyword arguments ``x509_issuer_name``,</span>
<span class="sd">            ``x509_serial_number`` and ``x509_digest``, and is expected to return an iterable of one or more</span>
<span class="sd">            strings containing a PEM-formatted certificate and a chain of intermediate certificates, if needed.</span>
<span class="sd">            Implies **require_x509=True**.</span>
<span class="sd">        :type cert_resolver: callable</span>
<span class="sd">        :param ca_pem_file:</span>
<span class="sd">            Filename of a PEM file containing certificate authority information to use when verifying certificate-based</span>
<span class="sd">            signatures.</span>
<span class="sd">        :type ca_pem_file: string or bytes</span>
<span class="sd">        :param ca_path:</span>
<span class="sd">            Path to a directory containing PEM-formatted certificate authority files to use when verifying</span>
<span class="sd">            certificate-based signatures. If neither **ca_pem_file** nor **ca_path** is given, the Mozilla CA bundle</span>
<span class="sd">            provided by :py:mod:`certifi` will be loaded.</span>
<span class="sd">        :type ca_path: string</span>
<span class="sd">        :param hmac_key: If using HMAC, a string containing the shared secret.</span>
<span class="sd">        :type hmac_key: string</span>
<span class="sd">        :param validate_schema: Whether to validate **data** against the XML Signature schema.</span>
<span class="sd">        :type validate_schema: boolean</span>
<span class="sd">        :param parser:</span>
<span class="sd">            Custom XML parser instance to use when parsing **data**. The default parser arguments used by SignXML are:</span>
<span class="sd">            ``resolve_entities=False``. See https://lxml.de/FAQ.html#how-do-i-use-lxml-safely-as-a-web-service-endpoint.</span>
<span class="sd">        :type parser: :py:class:`lxml.etree.XMLParser` compatible parser</span>
<span class="sd">        :param uri_resolver:</span>
<span class="sd">            Function to use to resolve reference URIs that don&#39;t start with &quot;#&quot;. The function is called with a single</span>
<span class="sd">            string argument containing the URI to be resolved, and is expected to return a lxml.etree node or string.</span>
<span class="sd">        :type uri_resolver: callable</span>
<span class="sd">        :param id_attribute:</span>
<span class="sd">            Name of the attribute whose value ``URI`` refers to. By default, SignXML will search for &quot;Id&quot;, then &quot;ID&quot;.</span>
<span class="sd">        :type id_attribute: string</span>
<span class="sd">        :param expect_references:</span>
<span class="sd">            Number of references to expect in the signature. If this is not 1, an array of VerifyResults is returned.</span>
<span class="sd">            If set to a non-integer, any number of references is accepted (otherwise a mismatch raises an error).</span>
<span class="sd">        :type expect_references: int or boolean</span>
<span class="sd">        :param ignore_ambiguous_key_info:</span>
<span class="sd">            Ignore the presence of a KeyValue element when X509Data is present in the signature and used for verifying.</span>
<span class="sd">            The presence of both elements is an ambiguity and a security hazard. The public key used to sign the</span>
<span class="sd">            document is already encoded in the certificate (which is in X509Data), so the verifier must either ignore</span>
<span class="sd">            KeyValue or make sure it matches what&#39;s in the certificate. SignXML does not implement the functionality</span>
<span class="sd">            necessary to match the keys, and throws an InvalidInput error instead. Set this to True to bypass the error</span>
<span class="sd">            and validate the signature using X509Data only.</span>
<span class="sd">        :type ignore_ambiguous_key_info: boolean</span>

<span class="sd">        :raises: :py:class:`cryptography.exceptions.InvalidSignature`</span>

<span class="sd">        :returns: VerifyResult object with the signed data, signed xml and signature xml</span>
<span class="sd">        :rtype: VerifyResult</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hmac_key</span> <span class="o">=</span> <span class="n">hmac_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_x509</span> <span class="o">=</span> <span class="n">require_x509</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x509_cert</span> <span class="o">=</span> <span class="n">x509_cert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="o">=</span> <span class="n">parser</span>

        <span class="k">if</span> <span class="n">x509_cert</span> <span class="ow">or</span> <span class="n">cert_resolver</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">require_x509</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">id_attribute</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_attributes</span> <span class="o">=</span> <span class="p">(</span><span class="n">id_attribute</span><span class="p">,</span> <span class="p">)</span>

        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_root</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">signature_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_signature</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

        <span class="c1"># HACK: deep copy won&#39;t keep root&#39;s namespaces</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">signature_ref</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">validate_schema</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span><span class="o">.</span><span class="n">assertValid</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>

        <span class="n">signed_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="s2">&quot;SignedInfo&quot;</span><span class="p">)</span>
        <span class="n">c14n_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">signed_info</span><span class="p">,</span> <span class="s2">&quot;CanonicalizationMethod&quot;</span><span class="p">)</span>
        <span class="n">c14n_algorithm</span> <span class="o">=</span> <span class="n">c14n_method</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Algorithm&quot;</span><span class="p">)</span>
        <span class="n">inclusive_ns_prefixes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inclusive_ns_prefixes</span><span class="p">(</span><span class="n">c14n_method</span><span class="p">)</span>
        <span class="n">signature_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">signed_info</span><span class="p">,</span> <span class="s2">&quot;SignatureMethod&quot;</span><span class="p">)</span>
        <span class="n">signature_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="s2">&quot;SignatureValue&quot;</span><span class="p">)</span>
        <span class="n">signature_alg</span> <span class="o">=</span> <span class="n">signature_method</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Algorithm&quot;</span><span class="p">)</span>
        <span class="n">raw_signature</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">signature_value</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">x509_data</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ds:KeyInfo/ds:X509Data&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
        <span class="n">key_value</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ds:KeyInfo/ds:KeyValue&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
        <span class="n">der_encoded_key_value</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ds:KeyInfo/dsig11:DEREncodedKeyValue&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
        <span class="n">signed_info_c14n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c14n</span><span class="p">(</span><span class="n">signed_info</span><span class="p">,</span>
                                      <span class="n">algorithm</span><span class="o">=</span><span class="n">c14n_algorithm</span><span class="p">,</span>
                                      <span class="n">inclusive_ns_prefixes</span><span class="o">=</span><span class="n">inclusive_ns_prefixes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">x509_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_x509</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">OpenSSL.crypto</span> <span class="kn">import</span> <span class="n">load_certificate</span><span class="p">,</span> <span class="n">X509</span><span class="p">,</span> <span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">verify</span><span class="p">,</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">OpenSSLCryptoError</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x509_cert</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x509_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;Expected a X.509 certificate based signature&quot;</span><span class="p">)</span>
                <span class="n">certs</span> <span class="o">=</span> <span class="p">[</span><span class="n">cert</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">cert</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_findall</span><span class="p">(</span><span class="n">x509_data</span><span class="p">,</span> <span class="s2">&quot;X509Certificate&quot;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">certs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">x509_iss</span> <span class="o">=</span> <span class="n">x509_data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ds:X509IssuerSerial/ds:X509IssuerName&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
                    <span class="n">x509_sn</span> <span class="o">=</span> <span class="n">x509_data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ds:X509IssuerSerial/ds:X509SerialNumber&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
                    <span class="n">x509_digest</span> <span class="o">=</span> <span class="n">x509_data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;dsig11:X509Digest&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cert_resolver</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x509_iss</span><span class="p">,</span> <span class="n">x509_sn</span><span class="p">,</span> <span class="n">x509_digest</span><span class="p">)):</span>
                        <span class="n">cert_chain</span> <span class="o">=</span> <span class="n">cert_resolver</span><span class="p">(</span><span class="n">x509_issuer_name</span><span class="o">=</span><span class="n">x509_iss</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">x509_iss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="n">x509_serial_number</span><span class="o">=</span><span class="n">x509_sn</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">x509_sn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="n">x509_digest</span><span class="o">=</span><span class="n">x509_digest</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">x509_digest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cert_chain</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">InvalidCertificate</span><span class="p">(</span><span class="s2">&quot;No certificate found for given X509 data&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X509</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cert_chain</span><span class="p">):</span>
                            <span class="n">cert_chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_certificate</span><span class="p">(</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">add_pem_header</span><span class="p">(</span><span class="n">cert</span><span class="p">))</span> <span class="k">for</span> <span class="n">cert</span> <span class="ow">in</span> <span class="n">cert_chain</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Expected to find an X509Certificate element in the signature&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; (X509SubjectName, X509SKI are not supported)&quot;</span>
                        <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cert_chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_certificate</span><span class="p">(</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">add_pem_header</span><span class="p">(</span><span class="n">cert</span><span class="p">))</span> <span class="k">for</span> <span class="n">cert</span> <span class="ow">in</span> <span class="n">certs</span><span class="p">]</span>
                <span class="n">signing_cert</span> <span class="o">=</span> <span class="n">verify_x509_cert_chain</span><span class="p">(</span><span class="n">cert_chain</span><span class="p">,</span> <span class="n">ca_pem_file</span><span class="o">=</span><span class="n">ca_pem_file</span><span class="p">,</span> <span class="n">ca_path</span><span class="o">=</span><span class="n">ca_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x509_cert</span><span class="p">,</span> <span class="n">X509</span><span class="p">):</span>
                <span class="n">signing_cert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x509_cert</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signing_cert</span> <span class="o">=</span> <span class="n">load_certificate</span><span class="p">(</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">add_pem_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x509_cert</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">cert_subject_name</span> <span class="ow">and</span> <span class="n">signing_cert</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span><span class="o">.</span><span class="n">commonName</span> <span class="o">!=</span> <span class="n">cert_subject_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidSignature</span><span class="p">(</span><span class="s2">&quot;Certificate subject common name mismatch&quot;</span><span class="p">)</span>

            <span class="n">signature_digest_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_signature_digest_method</span><span class="p">(</span><span class="n">signature_alg</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="s2">&quot;ecdsa-&quot;</span> <span class="ow">in</span> <span class="n">signature_alg</span><span class="p">:</span>
                <span class="n">raw_signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_dss_signature</span><span class="p">(</span>
                    <span class="n">raw_signature</span><span class="p">,</span> <span class="n">signing_cert</span><span class="o">.</span><span class="n">get_pubkey</span><span class="p">()</span><span class="o">.</span><span class="n">bits</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">verify</span><span class="p">(</span><span class="n">signing_cert</span><span class="p">,</span> <span class="n">raw_signature</span><span class="p">,</span> <span class="n">signed_info_c14n</span><span class="p">,</span> <span class="n">signature_digest_method</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">OpenSSLCryptoError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lib</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">reason</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">raise</span> <span class="n">InvalidSignature</span><span class="p">(</span><span class="s2">&quot;Signature verification failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span>

            <span class="c1"># If both X509Data and KeyValue are present, match one against the other and raise an error on mismatch</span>
            <span class="k">if</span> <span class="n">key_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_key_value_matches_cert_public_key</span><span class="p">(</span><span class="n">key_value</span><span class="p">,</span> <span class="n">signing_cert</span><span class="o">.</span><span class="n">get_pubkey</span><span class="p">(),</span>
                                                                <span class="n">signature_alg</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ignore_ambiguous_key_info</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;Both X509Data and KeyValue found and they represent different public keys. &quot;</span>
                                           <span class="s2">&quot;Use verify(ignore_ambiguous_key_info=True) to ignore KeyValue and validate &quot;</span>
                                           <span class="s2">&quot;using X509Data only.&quot;</span><span class="p">)</span>

            <span class="c1"># If both X509Data and DEREncodedKeyValue are present, match one against the other and raise an error on</span>
            <span class="c1"># mismatch</span>
            <span class="k">if</span> <span class="n">der_encoded_key_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_der_key_value_matches_cert_public_key</span><span class="p">(</span><span class="n">der_encoded_key_value</span><span class="p">,</span> <span class="n">signing_cert</span><span class="o">.</span><span class="n">get_pubkey</span><span class="p">(),</span>
                                                                    <span class="n">signature_alg</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ignore_ambiguous_key_info</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;Both X509Data and DEREncodedKeyValue found and they represent different &quot;</span>
                                           <span class="s2">&quot;public keys. Use verify(ignore_ambiguous_key_info=True) to ignore &quot;</span>
                                           <span class="s2">&quot;DEREncodedKeyValue and validate using X509Data only.&quot;</span><span class="p">)</span>

            <span class="c1"># TODO: CN verification goes here</span>
            <span class="c1"># TODO: require one of the following to be set: either x509_cert or (ca_pem_file or ca_path) or common_name</span>
            <span class="c1"># Use ssl.match_hostname or code from it to perform match</span>
        <span class="k">elif</span> <span class="s2">&quot;hmac-sha&quot;</span> <span class="ow">in</span> <span class="n">signature_alg</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hmac_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s1">&#39;Parameter &quot;hmac_key&quot; is required when verifying a HMAC signature&#39;</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.hmac</span> <span class="kn">import</span> <span class="n">HMAC</span>
            <span class="n">signer</span> <span class="o">=</span> <span class="n">HMAC</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">ensure_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hmac_key</span><span class="p">),</span>
                          <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hmac_digest_method</span><span class="p">(</span><span class="n">signature_alg</span><span class="p">),</span>
                          <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>
            <span class="n">signer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">signed_info_c14n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raw_signature</span> <span class="o">!=</span> <span class="n">signer</span><span class="o">.</span><span class="n">finalize</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">InvalidSignature</span><span class="p">(</span><span class="s2">&quot;Signature mismatch (HMAC)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">der_encoded_key_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidInput</span><span class="p">(</span><span class="s2">&quot;Expected to find either KeyValue or X509Data XML element in KeyInfo&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_signature_with_pubkey</span><span class="p">(</span><span class="n">signed_info_c14n</span><span class="o">=</span><span class="n">signed_info_c14n</span><span class="p">,</span>
                                               <span class="n">raw_signature</span><span class="o">=</span><span class="n">raw_signature</span><span class="p">,</span>
                                               <span class="n">key_value</span><span class="o">=</span><span class="n">key_value</span><span class="p">,</span>
                                               <span class="n">der_encoded_key_value</span><span class="o">=</span><span class="n">der_encoded_key_value</span><span class="p">,</span>
                                               <span class="n">signature_alg</span><span class="o">=</span><span class="n">signature_alg</span><span class="p">)</span>

        <span class="n">verify_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">reference</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_findall</span><span class="p">(</span><span class="n">signed_info</span><span class="p">,</span> <span class="s2">&quot;Reference&quot;</span><span class="p">):</span>
            <span class="n">copied_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
            <span class="n">copied_signature_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_signature</span><span class="p">(</span><span class="n">copied_root</span><span class="p">)</span>
            <span class="n">transforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="s2">&quot;Transforms&quot;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">digest_alg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="s2">&quot;DigestMethod&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Algorithm&quot;</span><span class="p">)</span>
            <span class="n">digest_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="s2">&quot;DigestValue&quot;</span><span class="p">)</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_reference</span><span class="p">(</span><span class="n">copied_root</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">uri_resolver</span><span class="o">=</span><span class="n">uri_resolver</span><span class="p">)</span>
            <span class="n">payload_c14n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_transforms</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">transforms</span><span class="p">,</span> <span class="n">copied_signature_ref</span><span class="p">,</span> <span class="n">c14n_algorithm</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">digest_value</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_digest</span><span class="p">(</span><span class="n">payload_c14n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_digest_method</span><span class="p">(</span><span class="n">digest_alg</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">InvalidDigest</span><span class="p">(</span><span class="s2">&quot;Digest mismatch for reference </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verify_results</span><span class="p">)))</span>

            <span class="c1"># We return the signed XML (and only that) to ensure no access to unsigned data happens</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">payload_c14n_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">payload_c14n</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">etree</span><span class="o">.</span><span class="n">XMLSyntaxError</span><span class="p">:</span>
                <span class="n">payload_c14n_xml</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">verify_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VerifyResult</span><span class="p">(</span><span class="n">payload_c14n</span><span class="p">,</span> <span class="n">payload_c14n_xml</span><span class="p">,</span> <span class="n">signature</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">expect_references</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">verify_results</span><span class="p">)</span> <span class="o">!=</span> <span class="n">expect_references</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Expected to find </span><span class="si">{}</span><span class="s2"> references, but found </span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">InvalidSignature</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expect_references</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">verify_results</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">verify_results</span> <span class="k">if</span> <span class="n">expect_references</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">verify_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">check_key_value_matches_cert_public_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_value</span><span class="p">,</span> <span class="n">public_key</span><span class="p">,</span> <span class="n">signature_alg</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;ecdsa-&quot;</span> <span class="ow">in</span> <span class="n">signature_alg</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">(),</span> <span class="n">ec</span><span class="o">.</span><span class="n">EllipticCurvePublicKey</span><span class="p">):</span>
            <span class="n">ec_key_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">key_value</span><span class="p">,</span> <span class="s2">&quot;ECKeyValue&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;dsig11&quot;</span><span class="p">)</span>
            <span class="n">named_curve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">ec_key_value</span><span class="p">,</span> <span class="s2">&quot;NamedCurve&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;dsig11&quot;</span><span class="p">)</span>
            <span class="n">public_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">ec_key_value</span><span class="p">,</span> <span class="s2">&quot;PublicKey&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;dsig11&quot;</span><span class="p">)</span>
            <span class="n">key_data</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">public_key</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">key_data</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">key_data</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">key_data</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">key_data</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">curve_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_ecdsa_curves</span><span class="p">[</span><span class="n">named_curve</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;URI&quot;</span><span class="p">)]</span>

            <span class="n">pubk_curve</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">curve</span>
            <span class="n">pubk_x</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">x</span>
            <span class="n">pubk_y</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">y</span>

            <span class="k">return</span> <span class="n">curve_class</span> <span class="o">==</span> <span class="n">pubk_curve</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">==</span> <span class="n">pubk_x</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">==</span> <span class="n">pubk_y</span>

        <span class="k">elif</span> <span class="s2">&quot;dsa-&quot;</span> <span class="ow">in</span> <span class="n">signature_alg</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">(),</span> <span class="n">dsa</span><span class="o">.</span><span class="n">DSAPublicKey</span><span class="p">):</span>
            <span class="n">dsa_key_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">key_value</span><span class="p">,</span> <span class="s2">&quot;DSAKeyValue&quot;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long</span><span class="p">(</span><span class="n">dsa_key_value</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long</span><span class="p">(</span><span class="n">dsa_key_value</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long</span><span class="p">(</span><span class="n">dsa_key_value</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">pubk_p</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">p</span>
            <span class="n">pubk_q</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">q</span>
            <span class="n">pubk_g</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">g</span>

            <span class="k">return</span> <span class="n">p</span> <span class="o">==</span> <span class="n">pubk_p</span> <span class="ow">and</span> <span class="n">q</span> <span class="o">==</span> <span class="n">pubk_q</span> <span class="ow">and</span> <span class="n">g</span> <span class="o">==</span> <span class="n">pubk_g</span>

        <span class="k">elif</span> <span class="s2">&quot;rsa-&quot;</span> <span class="ow">in</span> <span class="n">signature_alg</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">(),</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPublicKey</span><span class="p">):</span>
            <span class="n">rsa_key_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">key_value</span><span class="p">,</span> <span class="s2">&quot;RSAKeyValue&quot;</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long</span><span class="p">(</span><span class="n">rsa_key_value</span><span class="p">,</span> <span class="s2">&quot;Modulus&quot;</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long</span><span class="p">(</span><span class="n">rsa_key_value</span><span class="p">,</span> <span class="s2">&quot;Exponent&quot;</span><span class="p">)</span>

            <span class="n">pubk_n</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">n</span>
            <span class="n">pubk_e</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">e</span>

            <span class="k">return</span> <span class="n">n</span> <span class="o">==</span> <span class="n">pubk_n</span> <span class="ow">and</span> <span class="n">e</span> <span class="o">==</span> <span class="n">pubk_e</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check_der_key_value_matches_cert_public_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">der_encoded_key_value</span><span class="p">,</span> <span class="n">public_key</span><span class="p">,</span> <span class="n">signature_alg</span><span class="p">):</span>
        <span class="n">der_public_key</span> <span class="o">=</span> <span class="n">load_der_public_key</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">der_encoded_key_value</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>

        <span class="k">if</span> <span class="s2">&quot;ecdsa-&quot;</span> <span class="ow">in</span> <span class="n">signature_alg</span> \
           <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">der_public_key</span><span class="p">,</span> <span class="n">ec</span><span class="o">.</span><span class="n">EllipticCurvePublicKey</span><span class="p">)</span> \
           <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">(),</span> <span class="n">ec</span><span class="o">.</span><span class="n">EllipticCurvePublicKey</span><span class="p">):</span>
            <span class="n">curve_class</span> <span class="o">=</span> <span class="n">der_public_key</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">curve</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">der_public_key</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">x</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">der_public_key</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">y</span>

            <span class="n">pubk_curve</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">curve</span>
            <span class="n">pubk_x</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">x</span>
            <span class="n">pubk_y</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">y</span>

            <span class="k">return</span> <span class="n">curve_class</span> <span class="o">==</span> <span class="n">pubk_curve</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">==</span> <span class="n">pubk_x</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">==</span> <span class="n">pubk_y</span>

        <span class="k">elif</span> <span class="s2">&quot;dsa-&quot;</span> <span class="ow">in</span> <span class="n">signature_alg</span> \
             <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">der_public_key</span><span class="p">,</span> <span class="n">dsa</span><span class="o">.</span><span class="n">DSAPublicKey</span><span class="p">)</span> \
             <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">(),</span> <span class="n">dsa</span><span class="o">.</span><span class="n">DSAPublicKey</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">der_public_key</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">parameter_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">p</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">der_public_key</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">parameter_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">q</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">der_public_key</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">parameter_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">g</span>

            <span class="n">pubk_p</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">p</span>
            <span class="n">pubk_q</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">q</span>
            <span class="n">pubk_g</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">g</span>

            <span class="k">return</span> <span class="n">p</span> <span class="o">==</span> <span class="n">pubk_p</span> <span class="ow">and</span> <span class="n">q</span> <span class="o">==</span> <span class="n">pubk_q</span> <span class="ow">and</span> <span class="n">g</span> <span class="o">==</span> <span class="n">pubk_g</span>

        <span class="k">elif</span> <span class="s2">&quot;rsa-&quot;</span> <span class="ow">in</span> <span class="n">signature_alg</span> \
             <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">der_public_key</span><span class="p">,</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPublicKey</span><span class="p">)</span> \
             <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">(),</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPublicKey</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">der_public_key</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">n</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">der_public_key</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">e</span>

            <span class="n">pubk_n</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">n</span>
            <span class="n">pubk_e</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">to_cryptography_key</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">e</span>

            <span class="k">return</span> <span class="n">n</span> <span class="o">==</span> <span class="n">pubk_n</span> <span class="ow">and</span> <span class="n">e</span> <span class="o">==</span> <span class="n">pubk_e</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_long</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="n">require</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span></div>
</pre></div>

          </div>
            
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">signxml  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">signxml</a></li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright Andrey Kislyuk and signxml contributors. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>